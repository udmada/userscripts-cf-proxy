amends "package://pkg.pkl-lang.org/pkl-pantry/com.github.actions@1.3.0#/Workflow.pkl"

name = "Deploy to Cloudflare"

on {
    push {
        branches { "master" }
        paths {
            "src/**"
            "Cargo.toml"
            "Cargo.lock"
            "wrangler.toml"
        }
    }
    pull_request {
        paths {
            "src/**"
            "Cargo.toml"
            "Cargo.lock"
            "wrangler.toml"
        }
    }
}

env {
    ["CLOUDFLARE_API_TOKEN"] = "${{ secrets.CLOUDFLARE_API_TOKEN }}"
    ["CLOUDFLARE_ACCOUNT_ID"] = "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
}

jobs {
    ["deploy"] {
        `runs-on` = "ubuntu-slim"
        environment = new { name = "publish-and-release" }
        steps {
            new { uses = "actions/checkout@v4" }
            new { uses = "jdx/mise-action@v2" }
            new {
                name = "Run tests"
                run = "cargo test --lib"
            }
            new {
                name = "Build WASM"
                run = "mise run build"
            }
            new {
                name = "Deploy to Cloudflare Workers"
                `if` = "github.event_name == 'push' && github.ref == 'refs/heads/master'"
                run = "mise run deploy"
            }
        }
    }
}
